<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/funcoes.js"></script>
    <title>Home</title>
    <link rel="icon" href="img/logo.jpeg" type="image/png">
    <link rel="stylesheet" href="css/style-PadraoDashboard.css">
    <link rel="stylesheet" href="css/style-DashboardHome.css">
    <link rel="stylesheet" href="css/style-PadraoTodos.css">
</head>

<body onload="listar_estufas()">
    <div class="pagina">
        <div class="barra-lateral">
            <div class="barra-logo">
                <span>VinTech</span>
                <img src="img/vintech.jpg" alt="">
            </div>
            <div class="barra-itens">
                <ul>
                    <a>
                        <li class="selected">Home</li>
                    </a>
                    <a href="DashboardPlantacoes.html">
                        <li>Plantações</li>
                    </a>
                    <a href="DashboardConfig.html" id="item_config">
                        <li>Configurações</li>
                    </a>
                </ul>
            </div>
            <div class="barra-usuario">
                <div class="barra-fotoUsuario">
                    <img  id="imagemUsuario" src="" alt="Foto Usuário">
                    <span id="nome_usuario"></span>
                    <span id="cargo_usuario"></span>
                </div>
            </div>
            <div class="barra-button">
                <button onclick="limparSessao()">Sair</button>
            </div>
        </div>
        <div class="container">
            <div class="superior">
                <div class="superior_esquerda">
                    <div class="titulo">
                        <h1>
                            Informações de hoje
                        </h1>
                        <span>
                            27/04/2023
                        </span>
                    </div>
                    <div class="caixas">
                        <div class="caixa">
                            <h3>Estufas em perigo</h3>
                            <span id="num_perigo">0</span>
                        </div>
                        <div class="caixa">
                            <h3>
                                Estufas em alerta
                            </h3>
                            <span id="num_alerta">0</span>
                        </div>
                        <div class="caixa">
                            <h3>
                                Estufas em estado ideal
                            </h3>
                            <span id="num_ideal">0</span>
                        </div>
                    </div>
                </div>
                <div class="superior_direita">
                    <div class="top_estufas">
                        <h2>
                            Top estufas
                        </h2>
                        <div class="lista" id="top_estufas">
                        </div>
                    </div>
                </div>
            </div>
            <!-- Começo da parte inferior -->
            <div class="inferior">
                <div class="inferior_esquerda">
                    <div class="grafico">
                        <div class="titulo_grafico">
                            <h2>
                                Estufa em estado ideal
                            </h2>
                        </div>
                        <h1 id="estufa_ideal" style="color: rgb(36, 180, 60);"></h1>
                    </div>
                    <div class="grafico">
                        <div class="titulo_grafico">
                            <h2>
                                Estufa em estado de perigo
                            </h2>
                        </div>
                        <h1 id="estufa_perigo" style="color: brown;"></h1>
                    </div>
                </div>
                <div class="inferior_direita">
                    <div class="uvas_cultivo" id="uvas_cultivo">
                        <h3>
                            Uvas em cultivo
                        </h3>
                        <div class="lista_uvas" id="lista_uvas">
                        </div>
                    </div>
                </div>
            </div>

</body>

</html>
<script>
    var idChefe = sessionStorage.ID_USUARIO;
    var nomeUsuario = sessionStorage.NOME_USUARIO;
    var loginUsuario = sessionStorage.LOGIN_USUARIO;
    var emailUsuario = sessionStorage.EMAIL_USUARIO;
    var fkEmpresa = sessionStorage.FK_EMPRESA;
    var fkChefe = sessionStorage.ID_CHEFE;
    var imagemAdm = sessionStorage.IMAGEM_USUARIO;

    imagemUsuario.src = imagemAdm

    validarSessao()
    function listar_estufas() {
        fetch("/estufa/listar_plant", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                fkEmpresaServer: fkEmpresa
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                console.log(resposta);

                listaAlertas =
                    [
                        0, //Seguro
                        0, //Alerta
                        0 // Perigo
                    ]

                lista_estufa_perigo = []
                lista_estufa_alerta = []
                lista_estufa_segura = []    

                lista_uva_js = []

                resposta.json().then(json => {
                    var maior_temp = -9999
                    var menor_temp = 9999
                    var maior_umid = -9999
                    var menor_umid = 9999
                    for (let x in json) {
                        let tempRegis = Number(json[x].temperaturaRegistro);
                        let temperaturaMaxima = Number(json[x].tempMax);
                        let temperaturaMinima = Number(json[x].tempMin);
                        let temperaturaIdeal = Number((temperaturaMaxima + temperaturaMinima) / 2)
                        let temperaturaAlertaSuperior = Number(temperaturaIdeal + ((5 / 100) * temperaturaIdeal))
                        let temperaturaAlertaInferior = Number(temperaturaIdeal - ((5 / 100) * temperaturaIdeal))

                        let umidRegis = json[x].umidadeRegistro;
                        let umidadeMaxima = json[x].umidMax;
                        let umidadeMinima = json[x].umidMin;
                        let umidadeIdeal = (umidadeMaxima + umidadeMinima) / 2
                        let umidadeAlertaSuperior = umidadeIdeal + ((5 / 100) * umidadeIdeal)
                        let umidadeAlertaInferior = umidadeIdeal - ((5 / 100) * umidadeIdeal)

                        if ((tempRegis < temperaturaAlertaSuperior && tempRegis > temperaturaAlertaInferior) && (umidRegis < umidadeAlertaSuperior && umidRegis > umidadeAlertaInferior)) {
                            string = "../img/check-box.png"
                            listaAlertas[0]++
                            estufa_ideal.innerHTML = `${json[x].nomeEstufa}<br> Temp: ${tempRegis} / Umid: ${umidRegis}`
                            
                        }
                        else if ((tempRegis <= temperaturaMinima || tempRegis >= temperaturaMaxima) || (umidRegis <= umidadeMinima || umidRegis >= umidadeMaxima)) {
                            string = "../img/cancelar.png"
                            if (umidRegis > maior_umid || umidRegis < menor_umid || tempRegis > maior_temp || tempRegis < menor_temp){
                                maior_umid = umidRegis
                                menor_umid = umidRegis
                                menor_temp = tempRegis
                                maior_temp = tempRegis
                                estufa_perigo.innerHTML = `${json[x].nomeEstufa}<br> Temp: ${tempRegis} / Umid: ${umidRegis}`
                            }
                            listaAlertas[1]++
                        }
                        else {
                            string = "../img/warning.png"
                            listaAlertas[2]++
                        }
                        if(lista_uva_js.indexOf(json[x].nomeUva == -1)){
                            lista_uva_js.push(json[x].nomeUva)
                            lista_uvas.innerHTML += `<h2>${json[x].nomeEstufa}</h2>`
                            lista_uvas.innerHTML += `<ul>${json[x].nomeUva}</ul>`
                        }
                    }
                    num_ideal.innerHTML = listaAlertas[0]
                    num_perigo.innerHTML = listaAlertas[1]
                    num_alerta.innerHTML = listaAlertas[2]

                    for(x in lista_estufa_perigo){
                        top_estufas.innerHTML += `
                            <div class="linha-lista">
                                <li>${json[x].nomeEstufa}</li>
                                <div id="imagem"><img src="img/cancelar.png"></div>
                            </div>`
                    }
                    for(y in lista_estufa_alerta){
                        top_estufas.innerHTML += `
                            <div class="linha-lista">
                                <li>${json[y].nomeEstufa}</li>
                                <div id="imagem"><img src="img/warning.png"></div>
                            </div>
                        `
                    }
                    for(z in lista_estufa_segura){
                        top_estufas.innerHTML += `
                            <div class="linha-lista">
                                <li>${json[z].nomeEstufa}</li>
                                <div id="imagem"><img src="img/check-box.png"></div>
                            </div>
                        `
                    }

                });
            } else {
                console.log("Houve um erro ao tentar consultar as plantações");
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }

    var alertas = [];
    // Incio da funçao de alertas
    function obterdados(idPlantacao,temperaturaRegistro,umidadeRegistro){
        fetch(`/medidas/tempo-real/${idPlantacao},${temperaturaRegistro},${umidadeRegistro}`)
        .then(resposta => {

            if (resposta.ok) {
                resposta.json().then(resposta => {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    alertar(resposta,idPlantacao);
                });
            } else{
                console.error('Nenhum dado encontrado')
            }
        })
        .catch(function(error) {
            console.error(`Erro na obtenção dos dados da plantação para o gráfico:
            ${error.message}`);
        });
    }

    function alertar (resposta,idPlantacao,temperaturaRegistro,umidadeRegistro){
        var temp = resposta[0].temperatura;
        var umd = resposta[0].umidade;

        console.log(idPlantacao == resposta[0].fkPlantacao)
        var grauDeAviso = '';
        // Criação do json com as metricas
        var limites_temp = {
         perigo_baixo   : 11,
         alerta_baixo: 12,
         bom_baixo: 13,
         ideal: 15,
         bom_alto: 17,
         alerta_alto: 20,
         perigo_alto: 21
        };
        var limites_umd = {
        perigo_baixo: 17,
        alerta_baixo: 19,
        bom_baixo: 24,
        ideal: 30,
        bom_alto: 35,
        alerta_alto: 37,
        perigo_alto: 38
        };

        var classe_temperatura = 'cor-alerta';
        var classe_umidade = 'cor-alerta';
        
        if (temperaturaRegistro >= limites_temp.perigo_alto) {
        classe_temperatura = 'cor-alerta perigo-quente';
        grauDeAviso = 'perigo quente'
        grauDeAvisoCor = 'cor-alerta perigo-quente' 
        exibirAlerta(temperaturaRegistro,idPlantacao,grauDeAviso,grauDeAvisoCor)
        } else if( temperaturaRegistro >= limites_temp.bom_alto && temperaturaRegistro < limites_temp.alerta_alto){
        classe_temperaturaRegistro = 'cor-alerta alerta-quente';
        grauDeAviso = 'alerta quente'
        grauDeAvisoCor = 'cor-alerta alerta-quente'
        exibirAlerta(temperaturaRegistro,idPlantacao,grauDeAviso,grauDeAvisoCor)
        }else if(temperaturaRegistro > limites_temp.perigo_baixo && temperaturaRegistro < limites_temp.bom_baixo){
        classe_temperaturaRegistro = 'cor-alerta alerta-frio';
        grauDeAviso = 'alerta frio'
        grauDeAvisoCor = 'cor-alerta alerta-frio'
        exibirAlerta(temperaturaRegistro,idPlantacao,grauDeAviso,grauDeAvisoCor)
        }else if( temperaturaRegistro < limites_temp.alerta_baixo && temperaturaRegistro.limites_temp.perigo_baixo){
        classe_temperaturaRegistro = 'cor-alerta perigo-frio';
        grauDeAviso = 'perigo frio'
        grauDeAvisoCor = 'cor-alerta perigo-quente'
        exibirAlerta(temperaturaRegistro,idPlantacao,grauDeAviso,grauDeAvisoCor)
        }

        if (umidadeRegistro >= limites_umd.perigo_alto) {
        classe_umidade = 'cor-alerta perigo-quente';
        grauDeAviso = 'perigo quente'
        grauDeAvisoCor = 'cor-alerta perigo-quente'     
        exibirAlerta(umidadeRegistro,idPlantacao,grauDeAviso,grauDeAvisoCor)
        } else if( umidadeRegistro >= limites_umd.bom_alto && umidadeRegistro < limites_umd.alerta_alto){
        classe_umidadeRegistro = 'cor-alerta alerta-quente';
        grauDeAviso = 'alerta quente'
        grauDeAvisoCor = 'cor-alerta alerta-quente'
        exibirAlerta(umidadeRegistro,idPlantacao,grauDeAviso,grauDeAvisoCor)
        }else if(umidadeRegistro > limites_umd.perigo_baixo && umidadeRegistro < limites_umd.bom_baixo){
        classe_umidadeRegistro = 'cor-alerta alerta-frio';
        grauDeAviso = 'alerta frio'
        grauDeAvisoCor = 'cor-alerta alerta-frio'
        exibirAlerta(umidadeRegistro,idPlantacao,grauDeAviso,grauDeAvisoCor)
        }else if( umidadeRegistro < limites_umd.alerta_baixo && umidadeRegistro.limites_umd.perigo_baixo){
        classe_umidadeRegistro = 'cor-alerta perigo-frio';
        grauDeAviso = 'perigo frio'
        grauDeAvisoCor = 'cor-alerta perigo-quente'
        exibirAlerta(umidadeRegistro,idPlantacao,grauDeAviso,grauDeAvisoCor)
        }        
    }
    function exibirCards(){
        alerta.innerHTML = '';

        for (var i = 0; i < alertas.length; i++) {
            var mensagem = alertas[index];
            alerta.innerHTML += transformarEmDiv(mensagem);
        }
    }
    function transformarEmDiv(){
        return `<div classs = "mensagem-alarme">
            <small>Temperatura ${temperaturaRegistro}.</small>
            <small> Umidade ${umidadeRegistro}.</small>
            </div>`
    }
    function exibirAlerta(temperaturaRegistro,umidadeRegistro,idPlantacao,grauDeAviso,grauDeAvisoCor){
    var indice = alertas.findIndex(item => item.idPlantacao == idPlantacao);

    if (indice >= 0) {
    alertas[indice] = {idPlantacao,temperaturaRegistro,umidadeRegistro,grauDeAviso,grauDeAvisoCor}
    }else {
        alertas.push({idPlantacao,temperaturaRegistro,umidadeRegistro,grauDeAviso,grauDeAvisoCor});
    }
    exibirCards()
    }

</script>