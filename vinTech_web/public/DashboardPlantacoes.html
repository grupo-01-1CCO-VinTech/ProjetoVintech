<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/funcoes.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="img/logo.jpeg" type="image/png">
    <link rel="stylesheet" href="css/style-PadraoDashboard.css">
    <link rel="stylesheet" href="css/style-Plantacao.css">
    <link rel="stylesheet" href="css/style-PadraoTodos.css">
    <title>Plantações</title>
</head>

<body>
    <div class="pagina">
        <div class="barra-lateral">
            <div class="barra-logo">
                <span>VinTech</span>
                <img src="img/vintech.jpg" alt="">
            </div>
            <div class="barra-itens">
                <ul>
                    <a href="DashboardHome.html">
                        <li>Home</li>
                    </a>
                    <a class="selected">
                        <li>Plantações</li>
                    </a>
                    <a href="DashboardConfig.html" id="item_config">
                        <li>Configurações</li>
                    </a>
                </ul>
            </div>
            <div class="barra-usuario">
                <div class="barra-fotoUsuario">
                    <img src="img/usuario.png" alt="Foto Usuário">
                    <span id="nome_usuario"></span>
                    <span id="cargo_usuario"></span>
                </div>
            </div>
            <div class="barra-button">
                <button onclick="limparSessao()">Sair</button>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <img src="img/uvaDetalhe.png" alt="Detalhe Uva">
            <a>Suas plantações</a>
            <span>Listagem de Estufas</span>
            <span class="linhaTitulo"></span>
        </div>
        <div class="containerCard-Grande">
            <div class="cardGrande">
                <div class="primeiraParte">
                    <div class="areaInput">
                        <input type="text" placeholder="Digite o nome da Plantação" class="inputPesquisa">
                    </div>
                    <div class="areaBtn">
                        <div class="cardBtns">
                            <div class="areaBotoes">
                                <div class="tituloBtn">
                                    <h3>Por Status</h3>
                                </div>
                                <div class="botoes">
                                    <button class="btnSeguro"><b>Seguro</b></button>
                                    <button class="btnAlerta"><b>Alerta</b></button>
                                    <button class="btnPerigo"><b>Perigo</b></button>
                                </div>
                            </div>
                            <div class="selectUva">
                                <h3>Por Uva</h3>
                                <select id="">
                                    <option value="">Tipos de Uvas</option>
                                    <option value="">Pinot Noir</option>
                                    <option value="">Malbec</option>
                                    <option value="">Syrah</option>
                                    <option value="">Merlot</option>
                                    <option value="">Carménère</option>
                                </select>
                            </div>

                            <div class="selectUva">
                                <h3>Por Plantação</h3>
                                <select id="">
                                    <option value="">Plantações</option>
                                    <option value="">Plantação 1 - Borgonha</option>
                                    <option value="">Plantação 2 - Viterbo</option>
                                    <option value="">Plantação 2 - Califórnia</option>
                                </select>
                            </div>
                            <div class="selectUva">
                                <h3>Ordenar por</h3>
                                <select id="select">
                                    <option value="">Perigos</option>
                                    <option value="">Temperatura acima do Ideal</option>
                                    <option value="">Umidade Muito Alta</option>
                                    <option value="">Dias Chuvosos</option>
                                    <option value="">Dias com a maior Temperatura</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="areaCardsPequenos" id="areaCardsPequenos">  
                    </div>
                </div>
            </div>
            <div class="containerGraficos">
                <h2>Sequência de Dias</h2>
                <div class="graficoBarraHorizontal">
                    <select id="">
                        <option value="">Mês: Janeiro</option>
                        <option value="">Mês: Fevereiro</option>
                        <option value="">Mês: Março</option>
                        <option value="">Mês: Abril</option>
                        <option value="">Mês: Maio</option>
                        <option value="">Mês: Junho</option>
                        <option value="">Mês: Julho</option>
                        <option value="">Mês: Agosto</option>
                        <option value="">Mês: Setembro</option>
                        <option value="">Mês: Outubro</option>
                        <option value="">Mês: Novembro</option>
                        <option value="">Mês: Dezembro</option>
                    </select>
                    <div>
                        <canvas id="graficoBarraDeitado"></canvas>
                    </div>
                </div>
                <div class="container-graficoPizza">
                    <a>Quantidade por Status</a>
                    <div class="statusImagens">
                        <div class="status">
                            <img src="img/check-box.png" alt="">
                            <a>Seguro</a>
                            <a>3</a>
                        </div>
                        <div class="status">
                            <img src="img/warning.png" alt="">
                            <a>Alerta</a>
                            <a>3</a>
                        </div>
                        <div class="status">
                            <img src="img/cancelar.png" alt="">
                            <a>Perigo</a>
                            <a>3</a>
                        </div>
                    </div>
                    <div class="areaGrafico">
                        <canvas id="graficoPizza" class="graficoPizza"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</body>

</html>
<script>
    
    var idChefe = sessionStorage.ID_USUARIO;
    var nomeUsuario = sessionStorage.NOME_USUARIO;
    var loginUsuario = sessionStorage.LOGIN_USUARIO;
    var emailUsuario = sessionStorage.EMAIL_USUARIO;
    var fkEmpresa = sessionStorage.FK_EMPRESA;
    var fkChefe = sessionStorage.ID_CHEFE;
    
    validarSessao()
    
    var qtdSeguro = 0
    var qtdAlerta = 0
    var qtdPerigo = 0

    const graficoBarraDeitado = document.getElementById('graficoBarraDeitado');
    new Chart(graficoBarraDeitado, {
        type: 'bar',
        data: {
            labels: ['Seguro', 'Alerta', 'Perigo'],
            datasets: [{
                label: 'Seguro',
                data: [12, 15, 03],
                borderWidth: 1,
                backgroundColor: [
                    '#00BF15',
                    '#FFDE59',
                    '#FF3131'
                ]
            }]
        },
        options: {
            indexAxis: 'y',
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    new Chart(graficoPizza, {
        type: 'pie',
        data: {
            datasets: [{
                label: 'Status',
                data: [3, 3, 3],
                borderWidth: 1,
                backgroundColor: [
                    '#00BF15',
                    '#FFDE59',
                    '#FF3131'
                ]
            }]
        },
    });

    function listar_estufas() {
        fetch("/estufa/listar_plant", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                fkEmpresaServer: fkEmpresa
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    for (let x in json) {
                        let tempRegis = Number(json[x].temperaturaRegistro);
                        let temperaturaMaxima = Number(json[x].tempMax);
                        let temperaturaMinima = Number(json[x].tempMin);
                        let temperaturaIdeal = Number((temperaturaMaxima + temperaturaMinima) / 2)
                        let temperaturaAlertaSuperior = Number(temperaturaIdeal + ((5/100) * temperaturaIdeal))
                        let temperaturaAlertaInferior = Number(temperaturaIdeal - ((5/100) * temperaturaIdeal))
                        
                        let umidRegis = json[x].umidadeRegistro;
                        let umidadeMaxima = json[x].umidMax;
                        let umidadeMinima = json[x].umidMin;
                        let umidadeIdeal = (umidadeMaxima + umidadeMinima) / 2
                        let umidadeAlertaSuperior = umidadeIdeal + ((5/100) * umidadeIdeal)
                        let umidadeAlertaInferior = umidadeIdeal - ((5/100) * umidadeIdeal)

                        let string = ""

                        if((tempRegis < temperaturaAlertaSuperior && tempRegis > temperaturaAlertaInferior) && (umidRegis < umidadeAlertaSuperior && umidRegis > umidadeAlertaInferior)){
                            string = "../img/check-box.png"
                        }
                        else if(((tempRegis > temperaturaAlertaSuperior && tempRegis < temperaturaMaxima) || (tempRegis < temperaturaAlertaInferior && tempRegis > temperaturaMinima)) || ((umidRegis > umidadeAlertaSuperior && umidRegis < umidadeMaxima) || (umidRegis < umidadeAlertaInferior && umidRegis > umidadeMinima))){
                            string = "../img/warning.png"
                        }
                        else if((tempRegis <= temperaturaMinima || tempRegis >= temperaturaMaxima) || (umidRegis <= umidadeMinima || umidRegis >= umidadeMaxima)){
                            string = "../img/cancelar.png"
                        }
                        areaCardsPequenos.innerHTML +=
                            `
                            <div class="cardPequeno" id='card${json[x].idEstufa}'>
                                <h2><a href="DashboardGraficosEstufas.html">${json[x].nomeEstufa}</a></h2>
                                <div class="ordemCardpequeno">
                                    <a id="title">Tipo de Uva</a>
                                    <a>${json[x].nomeUva}</a>
                                </div>
                                <div class="ordemCardpequeno">
                                    <a id="title">Umidade Atual (%)</a>
                                    <a>${json[x].temperaturaRegistro}</a>
                                </div>
                                <div class="ordemCardpequeno">
                                    <a id="title">Temperatura Atual(°C)</a>
                                    <a>${json[x].umidadeRegistro}</a>
                                </div> 
                                <div class="ordemCardpequeno">
                                    <a id="title">Status</a>
                                    <img src="${string}" alt="Botão Tudo OK">
                                </div>
                            </div>  
                        `

                    }
                });
            } else {
                console.log("Houve um erro ao tentar consultar as plantações");
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }
    //card.innerHTML =
    //    `
    //<h2><a href="DashboardGraficosEstufas.html">${jsonEstufas.estufa3.nome}</a></h2>
    //    <div class="ordemCardpequeno">
    //        <a id="title">Tipo de Uva</a>
    //        <a>${jsonEstufas.estufa3.tipoUva}</a>
    //    </div>
    //    <div class="ordemCardpequeno">
    //        <a id="title">Umidade Atual (%)</a>
    //        <a>${jsonEstufas.estufa3.umidAtual}</a>
    //    </div>
    //    <div class="ordemCardpequeno">
    //        <a id="title">Temperatura Atual(°C)</a>
    //        <a>${jsonEstufas.estufa3.tempAtual}</a>
    //    </div>
    //    <div class="ordemCardpequeno">
    //        <a id="title">Status</a>
    //        <img src="" alt="Botão Tudo OK" id="imagemStatusCarmenere">
    //    </div>
    //`
    //if (jsonEstufas.estufa3.status == "Seguro") {
    //    imagemStatusCarmenere.src = "img/check-box.png"
    //    contadorSeguro++
    //
    //} else if (jsonEstufas.estufa3.status == "Alerta") {
    //    imagemStatusCarmenere.src = "img/warning.png"
    //    contadorAlerta++
    //} else if (jsonEstufas.estufa3.status == "Perigo") {
    //    imagemStatusCarmenere.src = "img/cancelar.png"
    //    contadorPerigo++
    //}
    //listaContadores.push(contadorSeguro)
    //listaContadores.push(contadorAlerta)
    //listaContadores.push(contadorPerigo)

    listar_estufas()
</script>